<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puissance 4 - Next Level</title>
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            font-size: 3em;
            color: #00d4ff;
            text-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff;
            margin-bottom: 20px;
        }
        .header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .account-tab {
            cursor: pointer;
            padding: 10px 20px;
            background: linear-gradient(45deg, #00d4ff, #007bff);
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.5);
            transition: transform 0.3s;
        }
        .account-tab:hover {
            transform: translateY(-3px);
        }
        .game-wrapper {
            display: flex;
            flex-direction: row;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            justify-content: center;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(7, 80px);
            gap: 10px;
            background: #333;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            width: fit-content;
        }
        .cell {
            width: 80px;
            height: 80px;
            background: #222;
            border: 3px solid #444;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .cell:hover {
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.7);
        }
        .player1 {
            background: radial-gradient(circle, #ff5555, #cc0000);
            box-shadow: 0 0 20px #ff5555;
            animation: drop 0.6s ease;
        }
        .player2 {
            background: radial-gradient(circle, #ffd700, #ffaa00);
            box-shadow: 0 0 20px #ffd700;
            animation: drop 0.6s ease;
        }
        @keyframes drop {
            from { transform: translateY(-150px); }
            to { transform: translateY(0); }
        }
        .message {
            font-size: 1.8em;
            margin: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            color: #00d4ff;
            text-shadow: 0 0 5px #00d4ff;
        }
        .score, .stats {
            font-size: 1.3em;
            margin: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            color: #e0e0e0;
        }
        .buttons, .friend-section, .account-section {
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        button {
            padding: 15px 30px;
            font-size: 1.1em;
            cursor: pointer;
            background: linear-gradient(45deg, #00d4ff, #007bff);
            color: #fff;
            border: none;
            border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.5);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.8);
        }
        .auth-container, .game-container {
            display: none;
        }
        .auth-form, .friend-form, .account-form {
            margin: 20px auto;
            width: 400px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #00d4ff;
            border-radius: 10px;
            background: #222;
            color: #e0e0e0;
            font-size: 1em;
        }
        .friend-list {
            max-height: 250px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
        }
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        .chat-container {
            width: 300px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            display: none;
        }
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: #222;
            border-radius: 10px;
            color: #e0e0e0;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 10px auto;
            display: block;
        }
        @media (max-width: 900px) {
            .game-wrapper {
                flex-direction: column;
                align-items: center;
            }
            .chat-container {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="auth-container" id="auth-container">
        <div class="auth-form">
            <h2>Connexion / Inscription</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Mot de passe">
            <input type="text" id="username" placeholder="Nom d'utilisateur">
            <button id="login">Se connecter</button>
            <button id="signup">S'inscrire</button>
            <button id="googleLogin">Connexion Google</button>
        </div>
    </div>

    <div class="game-container" id="game-container">
        <div class="header">
            <h1>Puissance 4 - Next Level</h1>
            <div class="account-tab" id="accountTab">Compte</div>
        </div>
        <div class="message" id="message">Tour du Joueur 1</div>
        <div class="score">Score Joueur 1: <span id="score1">0</span> | Score Joueur 2: <span id="score2">0</span></div>
        <div class="stats">Victoires: <span id="wins">0</span> | Streak: <span id="streak">0</span></div>
        <div class="game-wrapper">
            <div class="grid" id="grid"></div>
            <div class="chat-container" id="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Message...">
                    <button id="sendChat">Envoyer</button>
                </div>
            </div>
        </div>
        <div class="buttons">
            <button id="reset">Réinitialiser</button>
            <select id="iaLevel">
                <option value="easy">IA Facile</option>
                <option value="normal">IA Normal</option>
                <option value="hard">IA Difficile</option>
                <option value="extreme">IA Extrême</option>
            </select>
            <button id="playIA">Jouer contre IA</button>
            <button id="createGame">Créer une partie</button>
            <button id="joinGame">Rejoindre une partie</button>
            <button id="showFriends">Gérer les amis</button>
            <button id="replay" style="display: none;">Rejouer</button>
        </div>
        <div class="friend-section" id="friend-section" style="display: none;">
            <div class="friend-form">
                <h3>Votre code d'ami : <span id="userId"></span></h3>
                <input type="text" id="friendId" placeholder="ID de l'ami à ajouter">
                <button id="submitFriend">Ajouter un ami</button>
                <div class="friend-list" id="friendList"></div>
            </div>
        </div>
        <div class="account-section" id="account-section" style="display: none;">
            <div class="account-form">
                <h3>Paramètres du Compte</h3>
                <img id="profilePic" class="profile-pic" src="" alt="Photo de profil" style="display: none;">
                <input type="text" id="newUsername" placeholder="Nouveau nom d'utilisateur">
                <button id="updateUsername">Mettre à jour le nom</button>
                <input type="password" id="newPassword" placeholder="Nouveau mot de passe">
                <button id="updatePassword">Mettre à jour le mot de passe</button>
                <button id="linkGoogle">Lier compte Google</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, updatePassword, linkWithPopup } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDocs, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getDatabase, ref, push, set, onValue, update, onChildAdded } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
          apiKey: "AIzaSyBmvD0pBikHRQlSj8VhGejiQufYsK2BsfQ",
          authDomain: "puissance-4-80249.firebaseapp.com",
          databaseURL: "https://puissance-4-80249-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "puissance-4-80249",
          storageBucket: "puissance-4-80249.firebasestorage.app",
          messagingSenderId: "829085554865",
          appId: "1:829085554865:web:6b2e12e2cd956d954dea90"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        const authContainer = document.getElementById('auth-container');
        const gameContainer = document.getElementById('game-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const usernameInput = document.getElementById('username');
        const loginButton = document.getElementById('login');
        const signupButton = document.getElementById('signup');
        const googleLoginButton = document.getElementById('googleLogin');
        const accountTab = document.getElementById('accountTab');
        const accountSection = document.getElementById('account-section');
        const newUsernameInput = document.getElementById('newUsername');
        const updateUsernameButton = document.getElementById('updateUsername');
        const newPasswordInput = document.getElementById('newPassword');
        const updatePasswordButton = document.getElementById('updatePassword');
        const linkGoogleButton = document.getElementById('linkGoogle');
        const profilePic = document.getElementById('profilePic');
        const grid = document.getElementById('grid');
        const message = document.getElementById('message');
        const score1 = document.getElementById('score1');
        const score2 = document.getElementById('score2');
        const wins = document.getElementById('wins');
        const streak = document.getElementById('streak');
        const resetButton = document.getElementById('reset');
        const playIAButton = document.getElementById('playIA');
        const iaLevelSelect = document.getElementById('iaLevel');
        const createGameButton = document.getElementById('createGame');
        const joinGameButton = document.getElementById('joinGame');
        const showFriendsButton = document.getElementById('showFriends');
        const replayButton = document.getElementById('replay');
        const friendSection = document.getElementById('friend-section');
        const userIdSpan = document.getElementById('userId');
        const friendIdInput = document.getElementById('friendId');
        const submitFriendButton = document.getElementById('submitFriend');
        const friendList = document.getElementById('friendList');
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChat');

        let currentPlayer = 1;
        let gameState = Array(6).fill().map(() => Array(7).fill(0));
        let isPlayingIA = false;
        let currentUser = null;
        let currentGameId = null;
        let playerRole = null; // 'player1' ou 'player2'
        let stats = { wins: 0, losses: 0, streak: 0 };

        // Authentification
        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                gameContainer.style.display = 'block';
                userIdSpan.textContent = user.uid;
                await loadUserProfile();
                createGrid();
                loadFriends();
                listenForInvites();
                if (user.photoURL) {
                    profilePic.src = user.photoURL;
                    profilePic.style.display = 'block';
                }
            } else {
                authContainer.style.display = 'block';
                gameContainer.style.display = 'none';
            }
        });

        loginButton.addEventListener('click', () => {
            signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .then(() => setUsername(usernameInput.value))
                .catch(error => alert(error.message));
        });

        signupButton.addEventListener('click', () => {
            createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .then(() => setUsername(usernameInput.value))
                .catch(error => alert(error.message));
        });

        googleLoginButton.addEventListener('click', () => {
            signInWithPopup(auth, googleProvider)
                .then(() => setUsername(usernameInput.value || auth.currentUser.displayName))
                .catch(error => alert(error.message));
        });

        accountTab.addEventListener('click', () => {
            accountSection.style.display = accountSection.style.display === 'none' ? 'block' : 'none';
        });

        updateUsernameButton.addEventListener('click', () => {
            const newUsername = newUsernameInput.value;
            if (newUsername) {
                setUsername(newUsername).then(() => {
                    newUsernameInput.value = '';
                    loadUserProfile();
                    loadFriends(); // Mettre à jour les listes d’amis
                });
            }
        });

        updatePasswordButton.addEventListener('click', () => {
            const newPassword = newPasswordInput.value;
            if (newPassword) {
                updatePassword(auth.currentUser, newPassword)
                    .then(() => {
                        alert('Mot de passe mis à jour !');
                        newPasswordInput.value = '';
                    })
                    .catch(error => alert(`Erreur : ${error.message}`));
            }
        });

        linkGoogleButton.addEventListener('click', () => {
            linkWithPopup(auth.currentUser, googleProvider)
                .then(() => {
                    alert('Compte Google lié !');
                    if (auth.currentUser.photoURL) {
                        profilePic.src = auth.currentUser.photoURL;
                        profilePic.style.display = 'block';
                    }
                })
                .catch(error => alert(`Erreur : ${error.message}`));
        });

        async function setUsername(username) {
            if (username) {
                await setDoc(doc(db, 'users', auth.currentUser.uid), { username }, { merge: true });
            }
        }

        async function loadUserProfile() {
            const userDoc = await getDocs(collection(db, 'users'));
            userDoc.forEach(doc => {
                if (doc.id === currentUser.uid) {
                    message.textContent = `Bienvenue, ${doc.data().username || 'Joueur'} !`;
                }
            });
        }

        // Créer la grille
        function createGrid() {
            grid.innerHTML = '';
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => dropPiece(col));
                    grid.appendChild(cell);
                }
            }
            updateGrid();
        }

        // Placer un jeton
        function dropPiece(column) {
            if (!currentUser) return;
            if (currentGameId) {
                if (playerRole === 'player1' && currentPlayer !== 1) return;
                if (playerRole === 'player2' && currentPlayer !== 2) return;
            }
            for (let row = 5; row >= 0; row--) {
                if (gameState[row][column] === 0) {
                    gameState[row][column] = currentPlayer;
                    if (currentGameId) updateGameStateInFirebase();
                    updateGrid();
                    if (checkWin(currentPlayer)) {
                        message.textContent = `Joueur ${currentPlayer} gagne !`;
                        updateStats(currentPlayer === 1 ? 'win' : 'loss');
                        replayButton.style.display = 'block';
                        return;
                    } else if (isBoardFull()) {
                        message.textContent = 'Égalité !';
                        updateStats('tie');
                        replayButton.style.display = 'block';
                        return;
                    }
                    currentPlayer = currentPlayer === 1 ? 2 : 1;
                    message.textContent = `Tour du Joueur ${currentPlayer}${currentGameId ? ` (Partie: ${currentGameId})` : ''}`;
                    if (isPlayingIA && currentPlayer === 2) {
                        setTimeout(() => iaPlay(iaLevelSelect.value), 500);
                    }
                    return;
                }
            }
        }

        // Mettre à jour la grille
        function updateGrid() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                cell.classList.remove('player1', 'player2');
                if (gameState[row][col] === 1) cell.classList.add('player1');
                else if (gameState[row][col] === 2) cell.classList.add('player2');
            });
        }

        // Vérifier la victoire
        function checkWin(player) {
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    if (gameState[row][col] === player && gameState[row][col + 1] === player && gameState[row][col + 2] === player && gameState[row][col + 3] === player) return true;
                }
            }
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 7; col++) {
                    if (gameState[row][col] === player && gameState[row + 1][col] === player && gameState[row + 2][col] === player && gameState[row + 3][col] === player) return true;
                }
            }
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 4; col++) {
                    if (gameState[row][col] === player && gameState[row + 1][col + 1] === player && gameState[row + 2][col + 2] === player && gameState[row + 3][col + 3] === player) return true;
                }
            }
            for (let row = 3; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    if (gameState[row][col] === player && gameState[row - 1][col + 1] === player && gameState[row - 2][col + 2] === player && gameState[row - 3][col + 3] === player) return true;
                }
            }
            return false;
        }

        // Vérifier si la grille est pleine
        function isBoardFull() {
            return gameState.every(row => row.every(cell => cell !== 0));
        }

        // Mettre à jour les stats
        function updateStats(result) {
            if (playerRole === 'player1') {
                if (result === 'win') {
                    stats.wins++;
                    stats.streak++;
                    score1.textContent = parseInt(score1.textContent) + 1;
                } else if (result === 'loss') {
                    stats.losses++;
                    stats.streak = 0;
                    score2.textContent = parseInt(score2.textContent) + 1;
                } else {
                    stats.streak = 0;
                }
            } else if (playerRole === 'player2') {
                if (result === 'win') {
                    stats.wins++;
                    stats.streak++;
                    score2.textContent = parseInt(score2.textContent) + 1;
                } else if (result === 'loss') {
                    stats.losses++;
                    stats.streak = 0;
                    score1.textContent = parseInt(score1.textContent) + 1;
                } else {
                    stats.streak = 0;
                }
            }
            wins.textContent = stats.wins;
            streak.textContent = stats.streak;
        }

        // Réinitialiser le jeu
        resetButton.addEventListener('click', () => {
            gameState = Array(6).fill().map(() => Array(7).fill(0));
            currentPlayer = 1;
            message.textContent = 'Tour du Joueur 1';
            isPlayingIA = false;
            currentGameId = null;
            playerRole = null;
            chatContainer.style.display = 'none';
            replayButton.style.display = 'none';
            updateGrid();
        });

        // Jouer contre l'IA
        playIAButton.addEventListener('click', () => {
            resetButton.click();
            isPlayingIA = true;
            playerRole = 'player1';
            message.textContent = `Tour du Joueur 1 (Vous) - IA ${iaLevelSelect.value}`;
        });

        // IA améliorée
        function iaPlay(level) {
            let availableColumns = [];
            for (let col = 0; col < 7; col++) {
                if (gameState[0][col] === 0) availableColumns.push(col);
            }
            if (availableColumns.length === 0) return;

            if (level === 'easy') {
                dropPiece(availableColumns[Math.floor(Math.random() * availableColumns.length)]);
            } else if (level === 'normal') {
                for (let col of availableColumns) {
                    let tempState = JSON.parse(JSON.stringify(gameState));
                    for (let row = 5; row >= 0; row--) {
                        if (tempState[row][col] === 0) {
                            tempState[row][col] = 2;
                            if (checkWin(2)) {
                                dropPiece(col);
                                return;
                            }
                            tempState[row][col] = 1;
                            if (checkWin(1)) {
                                dropPiece(col);
                                return;
                            }
                            break;
                        }
                    }
                }
                dropPiece(availableColumns[Math.floor(Math.random() * availableColumns.length)]);
            } else if (level === 'hard') {
                dropPiece(minimax(gameState, 4, true)[1]);
            } else if (level === 'extreme') {
                dropPiece(minimaxAlphaBeta(gameState, 6, -Infinity, Infinity, true)[1]);
            }
        }

        function evaluate(state) {
            let score = 0;
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    score += evaluateLine(state[row].slice(col, col + 4), 2);
                    score -= evaluateLine(state[row].slice(col, col + 4), 1);
                }
            }
            for (let col = 0; col < 7; col++) {
                for (let row = 0; row < 3; row++) {
                    let line = [state[row][col], state[row + 1][col], state[row + 2][col], state[row + 3][col]];
                    score += evaluateLine(line, 2);
                    score -= evaluateLine(line, 1);
                }
            }
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 4; col++) {
                    let line = [state[row][col], state[row + 1][col + 1], state[row + 2][col + 2], state[row + 3][col + 3]];
                    score += evaluateLine(line, 2);
                    score -= evaluateLine(line, 1);
                }
            }
            for (let row = 3; row < 6; row++) {
                for (let col = 0; col < 4; col++) {
                    let line = [state[row][col], state[row - 1][col + 1], state[row - 2][col + 2], state[row - 3][col + 3]];
                    score += evaluateLine(line, 2);
                    score -= evaluateLine(line, 1);
                }
            }
            return score;
        }

        function evaluateLine(line, player) {
            const opponent = player === 1 ? 2 : 1;
            let score = 0;
            const countPlayer = line.filter(cell => cell === player).length;
            const countOpponent = line.filter(cell => cell === opponent).length;
            const countEmpty = line.filter(cell => cell === 0).length;

            if (countPlayer === 4) score += 1000;
            else if (countPlayer === 3 && countEmpty === 1) score += 100;
            else if (countPlayer === 2 && countEmpty === 2) score += 10;
            if (countOpponent === 3 && countEmpty === 1) score -= 80;

            return score;
        }

        function minimax(state, depth, isMaximizing) {
            if (depth === 0 || checkWin(1) || checkWin(2) || isBoardFull()) {
                return [evaluate(state), null];
            }
            let bestCol = null;
            if (isMaximizing) {
                let maxEval = -Infinity;
                for (let col = 0; col < 7; col++) {
                    if (state[0][col] === 0) {
                        let newState = JSON.parse(JSON.stringify(state));
                        for (let row = 5; row >= 0; row--) {
                            if (newState[row][col] === 0) {
                                newState[row][col] = 2;
                                let evalScore = minimax(newState, depth - 1, false)[0];
                                if (evalScore > maxEval) {
                                    maxEval = evalScore;
                                    bestCol = col;
                                }
                                break;
                            }
                        }
                    }
                }
                return [maxEval, bestCol];
            } else {
                let minEval = Infinity;
                for (let col = 0; col < 7; col++) {
                    if (state[0][col] === 0) {
                        let newState = JSON.parse(JSON.stringify(state));
                        for (let row = 5; row >= 0; row--) {
                            if (newState[row][col] === 0) {
                                newState[row][col] = 1;
                                let evalScore = minimax(newState, depth - 1, true)[0];
                                if (evalScore < minEval) {
                                    minEval = evalScore;
                                    bestCol = col;
                                }
                                break;
                            }
                        }
                    }
                }
                return [minEval, bestCol];
            }
        }

        function minimaxAlphaBeta(state, depth, alpha, beta, isMaximizing) {
            if (depth === 0 || checkWin(1) || checkWin(2) || isBoardFull()) {
                return [evaluate(state), null];
            }
            let bestCol = null;
            if (isMaximizing) {
                let maxEval = -Infinity;
                for (let col = 0; col < 7; col++) {
                    if (state[0][col] === 0) {
                        let newState = JSON.parse(JSON.stringify(state));
                        for (let row = 5; row >= 0; row--) {
                            if (newState[row][col] === 0) {
                                newState[row][col] = 2;
                                let evalScore = minimaxAlphaBeta(newState, depth - 1, alpha, beta, false)[0];
                                if (evalScore > maxEval) {
                                    maxEval = evalScore;
                                    bestCol = col;
                                }
                                alpha = Math.max(alpha, evalScore);
                                if (beta <= alpha) break;
                                break;
                            }
                        }
                    }
                }
                return [maxEval, bestCol];
            } else {
                let minEval = Infinity;
                for (let col = 0; col < 7; col++) {
                    if (state[0][col] === 0) {
                        let newState = JSON.parse(JSON.stringify(state));
                        for (let row = 5; row >= 0; row--) {
                            if (newState[row][col] === 0) {
                                newState[row][col] = 1;
                                let evalScore = minimaxAlphaBeta(newState, depth - 1, alpha, beta, true)[0];
                                if (evalScore < minEval) {
                                    minEval = evalScore;
                                    bestCol = col;
                                }
                                beta = Math.min(beta, evalScore);
                                if (beta <= alpha) break;
                                break;
                            }
                        }
                    }
                }
                return [minEval, bestCol];
            }
        }

        // Créer une partie en ligne
        createGameButton.addEventListener('click', () => {
            if (!currentUser) return alert('Veuillez vous connecter');
            const gameRef = push(ref(realtimeDb, 'games'));
            currentGameId = gameRef.key;
            gameState = Array(6).fill().map(() => Array(7).fill(0));
            const gameData = {
                player1: currentUser.uid,
                player2: null,
                currentPlayer: 1,
                gameState: gameState,
                status: 'waiting',
                chat: []
            };
            set(gameRef, gameData).then(() => {
                playerRole = 'player1';
                message.textContent = `Partie créée (ID: ${currentGameId}) - En attente...`;
                chatContainer.style.display = 'block';
                listenToGameState();
                listenToChat();
            }).catch(error => alert(`Erreur : ${error.message}`));
        });

        // Rejoindre une partie
        joinGameButton.addEventListener('click', () => {
            const gameId = prompt('Entrez l’ID de la partie à rejoindre :');
            if (!gameId) return;
            joinGame(gameId);
        });

        function joinGame(gameId) {
            currentGameId = gameId;
            const gameRef = ref(realtimeDb, `games/${gameId}`);
            onValue(gameRef, snapshot => {
                const game = snapshot.val();
                if (!game) return alert('Partie invalide');
                if (game.player2) return alert('Partie complète');
                update(gameRef, {
                    player2: currentUser.uid,
                    status: 'playing'
                }).then(() => {
                    playerRole = 'player2';
                    chatContainer.style.display = 'block';
                    listenToGameState();
                    listenToChat();
                }).catch(error => alert(`Erreur : ${error.message}`));
            }, { onlyOnce: true });
        }

        // Écouter l’état de la partie
        function listenToGameState() {
            if (!currentGameId) return;
            const gameRef = ref(realtimeDb, `games/${currentGameId}`);
            onValue(gameRef, snapshot => {
                const game = snapshot.val();
                if (!game) return;
                gameState = game.gameState;
                currentPlayer = game.currentPlayer;
                updateGrid();
                message.textContent = `Tour du Joueur ${currentPlayer} (Partie: ${currentGameId})`;
                if (game.status === 'waiting') {
                    message.textContent = `En attente d’un joueur (ID: ${currentGameId})...`;
                }
            });
        }

        // Mettre à jour l’état dans Firebase
        function updateGameStateInFirebase() {
            if (!currentGameId) return;
            const gameRef = ref(realtimeDb, `games/${currentGameId}`);
            update(gameRef, { gameState, currentPlayer })
                .catch(error => console.error(`Erreur Firebase : ${error.message}`));
        }

        // Gérer les invitations
        function listenForInvites() {
            const invitesRef = ref(realtimeDb, `invites/${currentUser.uid}`);
            onChildAdded(invitesRef, snapshot => {
                const invite = snapshot.val();
                if (confirm(`Vous avez été invité à rejoindre la partie ${invite.gameId} par ${invite.from}. Accepter ?`)) {
                    joinGame(invite.gameId);
                }
            });
        }

        // Gérer les amis
        showFriendsButton.addEventListener('click', () => {
            friendSection.style.display = friendSection.style.display === 'none' ? 'block' : 'none';
        });

        submitFriendButton.addEventListener('click', () => {
            const friendId = friendIdInput.value;
            if (!friendId) return alert('Entrez un ID valide');
            setDoc(doc(db, 'friends', currentUser.uid, 'list', friendId), {
                addedAt: serverTimestamp()
            }).then(() => {
                alert('Ami ajouté !');
                friendIdInput.value = '';
                loadFriends();
            }).catch(error => alert(`Erreur : ${error.message}`));
        });

        async function loadFriends() {
            friendList.innerHTML = '';
            try {
                const friendsSnapshot = await getDocs(collection(db, 'friends', currentUser.uid, 'list'));
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const userMap = {};
                usersSnapshot.forEach(doc => {
                    userMap[doc.id] = doc.data().username || doc.id;
                });
                friendsSnapshot.forEach(doc => {
                    const friendId = doc.id;
                    const friendItem = document.createElement('div');
                    friendItem.classList.add('friend-item');
                    friendItem.innerHTML = `
                        <span>${userMap[friendId] || friendId}</span>
                        <button onclick="inviteFriend('${friendId}')">Inviter</button>
                    `;
                    friendList.appendChild(friendItem);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des amis :', error.message);
            }
        }

        window.inviteFriend = function(friendId) {
            if (!currentGameId) {
                createGameButton.click();
                setTimeout(() => sendInvite(friendId), 500);
            } else {
                sendInvite(friendId);
            }
        };

        function sendInvite(friendId) {
            const inviteRef = ref(realtimeDb, `invites/${friendId}/${currentGameId}`);
            set(inviteRef, {
                gameId: currentGameId,
                from: currentUser.uid,
                timestamp: Date.now()
            }).then(() => {
                alert(`Invitation envoyée à ${friendId} pour la partie ${currentGameId}`);
            }).catch(error => alert(`Erreur : ${error.message}`));
        }

        // Chat avec emojis
        sendChatButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            if (!currentGameId || !chatInput.value) return;
            const chatRef = push(ref(realtimeDb, `games/${currentGameId}/chat`));
            set(chatRef, {
                user: currentUser.uid,
                message: chatInput.value,
                timestamp: Date.now()
            }).then(() => {
                chatInput.value = '';
            }).catch(error => alert(`Erreur : ${error.message}`));
        }

        function listenToChat() {
            if (!currentGameId) return;
            const chatRef = ref(realtimeDb, `games/${currentGameId}/chat`);
            onChildAdded(chatRef, snapshot => {
                const msg = snapshot.val();
                const msgElement = document.createElement('div');
                msgElement.textContent = `${msg.user}: ${msg.message}`;
                chatMessages.appendChild(msgElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Rejouer
        replayButton.addEventListener('click', () => {
            if (isPlayingIA) {
                playIAButton.click();
            } else if (currentGameId) {
                gameState = Array(6).fill().map(() => Array(7).fill(0));
                currentPlayer = 1;
                updateGameStateInFirebase();
                message.textContent = `Tour du Joueur 1 (Partie: ${currentGameId})`;
                replayButton.style.display = 'none';
            }
        });
    </script>
</body>
</html>
